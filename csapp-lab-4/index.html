<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"scarboroughcoral.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="《深入理解计算机系统》之Architecture Lab。">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP 之 Arch Lab">
<meta property="og:url" content="https://scarboroughcoral.github.io/csapp-lab-4/index.html">
<meta property="og:site_name" content="李明岳的网络日志">
<meta property="og:description" content="《深入理解计算机系统》之Architecture Lab。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1555242018623&di=ff4c4f32ee75c291cc704b7ccdb29c1d&imgtype=0&src=http%3A%2F%2Fimg.zcool.cn%2Fcommunity%2F0157065c1c433aa8012029ac6eb3c7.jpg%402o.jpg">
<meta property="article:published_time" content="2019-04-14T16:39:24.000Z">
<meta property="article:modified_time" content="2021-08-23T15:42:16.990Z">
<meta property="article:author" content="李明岳">
<meta property="article:tag" content="CSAPP">
<meta property="article:tag" content="Operating System">
<meta property="article:tag" content="CSAPP Lab">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1555242018623&di=ff4c4f32ee75c291cc704b7ccdb29c1d&imgtype=0&src=http%3A%2F%2Fimg.zcool.cn%2Fcommunity%2F0157065c1c433aa8012029ac6eb3c7.jpg%402o.jpg">


<link rel="canonical" href="https://scarboroughcoral.github.io/csapp-lab-4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://scarboroughcoral.github.io/csapp-lab-4/","path":"csapp-lab-4/","title":"CSAPP 之 Arch Lab"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CSAPP 之 Arch Lab | 李明岳的网络日志</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">李明岳的网络日志</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Music"><span class="nav-number">2.</span> <span class="nav-text">Music</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSAPP-%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95"><span class="nav-number">3.</span> <span class="nav-text">CSAPP 实验记录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E6%A0%87"><span class="nav-number">4.</span> <span class="nav-text">实验目标</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-A"><span class="nav-number">4.1.</span> <span class="nav-text">Part A</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-B"><span class="nav-number">4.2.</span> <span class="nav-text">Part B</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-C"><span class="nav-number">4.3.</span> <span class="nav-text">Part C</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E5%89%8D%E7%9A%84%E5%BD%92%E7%BA%B3"><span class="nav-number">5.</span> <span class="nav-text">实验前的归纳</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arch-Lab"><span class="nav-number">6.</span> <span class="nav-text">Arch Lab</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-A-1"><span class="nav-number">6.1.</span> <span class="nav-text">Part A</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-B-1"><span class="nav-number">6.2.</span> <span class="nav-text">Part B</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-C-1"><span class="nav-number">6.3.</span> <span class="nav-text">Part C</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Version-1-0"><span class="nav-number">6.3.1.</span> <span class="nav-text">Version 1.0</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Version-2-0"><span class="nav-number">6.3.2.</span> <span class="nav-text">Version 2.0</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%80%E6%84%9F"><span class="nav-number">7.1.</span> <span class="nav-text">所感</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%80%E5%BE%97"><span class="nav-number">7.2.</span> <span class="nav-text">所得</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5"><span class="nav-number">7.3.</span> <span class="nav-text">下一步</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李明岳</p>
  <div class="site-description" itemprop="description">一个假的全栈工程师</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
    
    <div class="post-gallery-image">
      <img src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1555242018623&di=ff4c4f32ee75c291cc704b7ccdb29c1d&imgtype=0&src=http%3A%2F%2Fimg.zcool.cn%2Fcommunity%2F0157065c1c433aa8012029ac6eb3c7.jpg%402o.jpg" itemprop="contentUrl">
    </div>
    </div>

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://scarboroughcoral.github.io/csapp-lab-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李明岳">
      <meta itemprop="description" content="一个假的全栈工程师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李明岳的网络日志">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSAPP 之 Arch Lab
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-14 16:39:24" itemprop="dateCreated datePublished" datetime="2019-04-14T16:39:24+00:00">2019-04-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-23 15:42:16" itemprop="dateModified" datetime="2021-08-23T15:42:16+00:00">2021-08-23</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Science/" itemprop="url" rel="index"><span itemprop="name">Computer Science</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Science/Operating-System/" itemprop="url" rel="index"><span itemprop="name">Operating System</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <div class="note primary"><p>《深入理解计算机系统》之Architecture Lab。</p>
</div>

<span id="more"></span>

<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次实验主要是对第四章处理器体系结构的测验，还有一部分第五章的内容。</p>
<h2 id="Music"><a href="#Music" class="headerlink" title="Music"></a>Music</h2><iframe frameborder="no"  marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=28786838&auto=1&height=66"></iframe>


<h2 id="CSAPP-实验记录"><a href="#CSAPP-实验记录" class="headerlink" title="CSAPP 实验记录"></a>CSAPP 实验记录</h2><div class="note info"><p><strong><a href="/tags/CSAPP-Lab/">本系列文章</a>主要记录 CSAPP 3.0 的实验过程，所有实验记录文章请查看<a href="/tags/CSAPP-Lab/">这儿</a></strong></p>
</div>


<p>快速开始请访问 <code>CSAPP</code> <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">Lab</a> 官网，本次实验记录是基于 CSAPP 3.0，实验日期始于：<code>2019-4-1</code></p>
<h2 id="实验目标"><a href="#实验目标" class="headerlink" title="实验目标"></a>实验目标</h2><p>实验分为三部分，第一部分很简单，就是简单地考察一下汇编；第二部分是在hcl文件中添加iaddq指令的逻辑；第三部分是修改hcl和ncopy汇编文件使内存元素复制的速度尽可能达到最快。</p>
<h3 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h3><div class="note info no-icon"><p>目标：使用Y86-64汇编程序实现以下三个函数：</p>
</div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Architecture Lab: Part A </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * High level specs for the functions that the students will rewrite</span></span><br><span class="line"><span class="comment"> * in Y86-64 assembly language</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin examples */</span></span><br><span class="line"><span class="comment">/* linked list element */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ELE</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ELE</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; *list_ptr;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* sum_list - Sum the elements of a linked list */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">sum_list</span><span class="params">(list_ptr ls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (ls) &#123;</span><br><span class="line">	val += ls-&gt;val;</span><br><span class="line">	ls = ls-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* rsum_list - Recursive version of sum_list */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">rsum_list</span><span class="params">(list_ptr ls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ls)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">long</span> val = ls-&gt;val;</span><br><span class="line">	<span class="keyword">long</span> rest = rsum_list(ls-&gt;next);</span><br><span class="line">	<span class="keyword">return</span> val + rest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* copy_block - Copy src to dest and return xor checksum of src */</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">copy_block</span><span class="params">(<span class="keyword">long</span> *src, <span class="keyword">long</span> *dest, <span class="keyword">long</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">long</span> val = *src++;</span><br><span class="line">	*dest++ = val;</span><br><span class="line">	result ^= val;</span><br><span class="line">	len--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end examples */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Part-B"><a href="#Part-B" class="headerlink" title="Part B"></a>Part B</h3><div class="note info no-icon"><p>在hcl文件中添加iaddq指令的逻辑。</p>
</div>

<h3 id="Part-C"><a href="#Part-C" class="headerlink" title="Part C"></a>Part C</h3><div class="note info no-icon"><p>修改hcl和ncopy汇编文件使内存元素复制的速度尽可能达到最快，即CPE（cycles per element）越来越小。</p>
<ul>
<li>修改hcl内容首先要添加iaddq的实现</li>
<li>降低CPI，即处理ret、jmp预测、加载使用冒险。ret没必要处理。</li>
<li>程序性能优化（3e第五章）</li>
</ul>
</div>

<h2 id="实验前的归纳"><a href="#实验前的归纳" class="headerlink" title="实验前的归纳"></a>实验前的归纳</h2><p>概括一下这次实验用到的知识点。</p>
<p>首先是汇编相关的内容，通过第三章的学习，part A直接上手完成是没有问题的。<br>其次是hcl逻辑块的实现，这就需要对SEQ以及PIPE的实现及ISA有一定的了解。</p>
<h2 id="Arch-Lab"><a href="#Arch-Lab" class="headerlink" title="Arch Lab"></a>Arch Lab</h2><p>正式开始记录实验，Part C由于第五章内容还没有了解完全，所以准备后期二刷Part C。</p>
<h3 id="Part-A-1"><a href="#Part-A-1" class="headerlink" title="Part A"></a>Part A</h3><p>这一部分凭借汇编基础即可完成。不过还需要注意一下汇编的一些伪指令和格式问题。</p>
<ul>
<li>sum_list</li>
</ul>
<figure class="highlight x86asm"><figcaption><span>文件名：archlab/archlab-handout/sim/misc/sum.ys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># sum_list function coded by scarborough_coral</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.pos</span> <span class="number">0</span></span><br><span class="line">	irmovq stack,%rsp</span><br><span class="line">	<span class="keyword">call</span> main</span><br><span class="line">	halt</span><br><span class="line"></span><br><span class="line"># Sample linked list</span><br><span class="line"><span class="meta">.align</span> <span class="number">8</span></span><br><span class="line"><span class="symbol">ele1:</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0x00a</span></span><br><span class="line"><span class="meta">.quad</span> ele2</span><br><span class="line"><span class="symbol">ele2:</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0x0b0</span></span><br><span class="line"><span class="meta">.quad</span> ele3</span><br><span class="line"><span class="symbol">ele3:</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0xc00</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">sum_list:</span></span><br><span class="line">	xorq %rax,%rax</span><br><span class="line"><span class="symbol">	</span></span><br><span class="line"><span class="symbol">loop_start:</span></span><br><span class="line">	andq %rdi,%rdi</span><br><span class="line">	<span class="keyword">je</span> loop_end</span><br><span class="line"></span><br><span class="line">	mrmovq <span class="number">0</span>(%rdi),%rsi</span><br><span class="line">	addq %rsi,%rax</span><br><span class="line">	mrmovq <span class="number">8</span>(%rdi),%rsi</span><br><span class="line">	rrmovq %rsi,%rdi	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">jmp</span> loop_start</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">loop_end:</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">main:</span></span><br><span class="line">	irmovq ele1,%rdi</span><br><span class="line">	<span class="keyword">call</span> sum_list</span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.pos</span> <span class="number">1024</span></span><br><span class="line"><span class="symbol">stack:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>rsum_list</li>
</ul>
<figure class="highlight x86asm"><figcaption><span>文件名：archlab/archlab-handout/sim/misc/rsum.ys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.pos</span> <span class="number">0</span></span><br><span class="line">	irmovq stack,%rsp</span><br><span class="line">	<span class="keyword">call</span> main</span><br><span class="line">	halt</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.align</span> <span class="number">8</span></span><br><span class="line"><span class="symbol">ele1:</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0x00a</span></span><br><span class="line"><span class="meta">.quad</span> ele2</span><br><span class="line"><span class="symbol">ele2:</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0x0b0</span></span><br><span class="line"><span class="meta">.quad</span> ele3</span><br><span class="line"><span class="symbol">ele3:</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0xc00</span></span><br><span class="line"><span class="meta">.quad</span> <span class="number">0</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">rsum_list:</span></span><br><span class="line">	xorq %rax,%rax</span><br><span class="line">	andq %rdi,%rdi</span><br><span class="line">	<span class="keyword">jne</span> not_null</span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="symbol">not_null:</span></span><br><span class="line">	mrmovq <span class="number">0</span>(%rdi),%rsi</span><br><span class="line">	pushq %rsi</span><br><span class="line">	mrmovq <span class="number">8</span>(%rdi),%rdi</span><br><span class="line">	<span class="keyword">call</span> rsum_list</span><br><span class="line">	popq %rsi</span><br><span class="line">	addq %rsi,%rax</span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">main:</span></span><br><span class="line">	irmovq ele1,%rdi</span><br><span class="line">	<span class="keyword">call</span> rsum_list</span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.pos</span> <span class="number">1024</span></span><br><span class="line"><span class="symbol">stack:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>copy_block</li>
</ul>
<figure class="highlight x86asm"><figcaption><span>文件名：archlab/archlab-handout/sim/misc/copy.ys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.pos</span> <span class="number">0</span></span><br><span class="line">	irmovq stack,%rsp</span><br><span class="line">	<span class="keyword">call</span> main</span><br><span class="line">	halt</span><br><span class="line"><span class="meta">	</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.align</span> <span class="number">8</span></span><br><span class="line"><span class="symbol">src:</span></span><br><span class="line"><span class="meta">	.quad</span> <span class="number">0x00a</span></span><br><span class="line"><span class="meta">	.quad</span> <span class="number">0x0b0</span></span><br><span class="line"><span class="meta">	.quad</span> <span class="number">0xc00</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">dest:</span></span><br><span class="line"><span class="meta">	.quad</span> <span class="number">0x111</span></span><br><span class="line"><span class="meta">	.quad</span> <span class="number">0x222</span></span><br><span class="line"><span class="meta">	.quad</span> <span class="number">0x333</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">copy_block:</span></span><br><span class="line">	xorq %rax,%rax</span><br><span class="line">	pushq %r12</span><br><span class="line">	pushq %r13</span><br><span class="line">	irmovq <span class="number">$1</span>,%r13</span><br><span class="line">	irmovq <span class="number">$8</span>,%r12</span><br><span class="line"><span class="symbol">loop_start:</span>	</span><br><span class="line">	andq %rdx,%rdx</span><br><span class="line">	<span class="keyword">je</span> loop_end</span><br><span class="line">	mrmovq (%rdi),%rcx</span><br><span class="line">	rmmovq %rcx,(%rsi)</span><br><span class="line">	addq %r12,%rdi</span><br><span class="line">	addq %r12,%rsi</span><br><span class="line">	xorq %rcx,%rax</span><br><span class="line">	subq %r13,%rdx</span><br><span class="line">	<span class="keyword">jmp</span> loop_start</span><br><span class="line"><span class="symbol">loop_end:</span></span><br><span class="line">	popq %r12</span><br><span class="line">	popq %r13</span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">main:</span></span><br><span class="line">	irmovq src,%rdi</span><br><span class="line">	irmovq dest,%rsi</span><br><span class="line">	irmovq <span class="number">$3</span>,%rdx</span><br><span class="line">	<span class="keyword">call</span> copy_block</span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.pos</span> <span class="number">1024</span></span><br><span class="line"><span class="symbol">stack:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Part-B-1"><a href="#Part-B-1" class="headerlink" title="Part B"></a>Part B</h3><p>Part B 只需要按照writeup查看3e课本iaddq指令的阶段实现即可实现。</p>
<div class="note danger"><ol>
<li>可能会遇到找不到依赖库的问题，安装就行了</li>
<li>中途遇见了一个链接问题，是因为glibc版本太新，实验依赖的版本太过老旧导致一个<code>matherr</code>找不到问题，观察代码其他地方并没有用到，直接omit注释掉了。</li>
</ol>
</div>

<p>修改内容如下图：</p>
<p><img src="csapp-lab-4/seq.jpg"></p>
<p>hcl代码如下：</p>
<figure class="highlight vhdl"><figcaption><span>文件名：archlab/archlab-handout/sim/seq/seq-full.hcl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">#<span class="comment">/* $begin seq-all-hcl */</span></span><br><span class="line">####################################################################</span><br><span class="line">#  HCL Description <span class="keyword">of</span> Control <span class="keyword">for</span> Single Cycle Y86-<span class="number">64</span> Processor SEQ   #</span><br><span class="line">#  Copyright (C) Randal E. Bryant, David R. O<span class="symbol">&#x27;Hallaron</span>, <span class="number">2010</span>       #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">## Your task <span class="keyword">is</span> <span class="keyword">to</span> implement the iaddq instruction</span><br><span class="line">## The <span class="keyword">file</span> contains a declaration <span class="keyword">of</span> the icodes</span><br><span class="line">## <span class="keyword">for</span> iaddq (IIADDQ)</span><br><span class="line">## Your job <span class="keyword">is</span> <span class="keyword">to</span> add the rest <span class="keyword">of</span> the logic <span class="keyword">to</span> make it work</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#    C Include<span class="symbol">&#x27;s</span>.  Don<span class="symbol">&#x27;t</span> alter these                               #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">quote &#x27;#include &lt;stdio.h&gt;&#x27;</span><br><span class="line">quote &#x27;#include <span class="string">&quot;isa.h&quot;</span>&#x27;</span><br><span class="line">quote &#x27;#include <span class="string">&quot;sim.h&quot;</span>&#x27;</span><br><span class="line">quote <span class="symbol">&#x27;int</span> sim_main(int argc, char *argv[]);&#x27;</span><br><span class="line">quote <span class="symbol">&#x27;word_t</span> gen_pc()&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;&#x27;</span><br><span class="line">quote <span class="symbol">&#x27;int</span> main(int argc, char *argv[])&#x27;</span><br><span class="line">quote &#x27;  &#123;plusmode=<span class="number">0</span>;<span class="keyword">return</span> sim_main(argc,argv);&#125;&#x27;</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#    Declarations.  Do <span class="keyword">not</span> change/remove/delete any <span class="keyword">of</span> these       #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">##### Symbolic representation <span class="keyword">of</span> Y86-<span class="number">64</span> Instruction Codes #############</span><br><span class="line">wordsig INOP 	<span class="symbol">&#x27;I_NOP</span>&#x27;</span><br><span class="line">wordsig IHALT	<span class="symbol">&#x27;I_HALT</span>&#x27;</span><br><span class="line">wordsig IRRMOVQ	<span class="symbol">&#x27;I_RRMOVQ</span>&#x27;</span><br><span class="line">wordsig IIRMOVQ	<span class="symbol">&#x27;I_IRMOVQ</span>&#x27;</span><br><span class="line">wordsig IRMMOVQ	<span class="symbol">&#x27;I_RMMOVQ</span>&#x27;</span><br><span class="line">wordsig IMRMOVQ	<span class="symbol">&#x27;I_MRMOVQ</span>&#x27;</span><br><span class="line">wordsig IOPQ	<span class="symbol">&#x27;I_ALU</span>&#x27;</span><br><span class="line">wordsig IJXX	<span class="symbol">&#x27;I_JMP</span>&#x27;</span><br><span class="line">wordsig ICALL	<span class="symbol">&#x27;I_CALL</span>&#x27;</span><br><span class="line">wordsig IRET	<span class="symbol">&#x27;I_RET</span>&#x27;</span><br><span class="line">wordsig IPUSHQ	<span class="symbol">&#x27;I_PUSHQ</span>&#x27;</span><br><span class="line">wordsig IPOPQ	<span class="symbol">&#x27;I_POPQ</span>&#x27;</span><br><span class="line"># Instruction code <span class="keyword">for</span> iaddq instruction</span><br><span class="line">wordsig IIADDQ	<span class="symbol">&#x27;I_IADDQ</span>&#x27;</span><br><span class="line"></span><br><span class="line">##### Symbolic represenations <span class="keyword">of</span> Y86-<span class="number">64</span> <span class="keyword">function</span> codes                  #####</span><br><span class="line">wordsig FNONE    <span class="symbol">&#x27;F_NONE</span>&#x27;        # <span class="keyword">Default</span> <span class="keyword">function</span> code</span><br><span class="line"></span><br><span class="line">##### Symbolic representation <span class="keyword">of</span> Y86-<span class="number">64</span> Registers referenced explicitly #####</span><br><span class="line">wordsig RRSP     <span class="symbol">&#x27;REG_RSP</span>&#x27;    	# Stack Pointer</span><br><span class="line">wordsig RNONE    <span class="symbol">&#x27;REG_NONE</span>&#x27;   	# Special value indicating <span class="string">&quot;no register&quot;</span></span><br><span class="line"></span><br><span class="line">##### ALU Functions referenced explicitly                            #####</span><br><span class="line">wordsig ALUADD	<span class="symbol">&#x27;A_ADD</span>&#x27;		# ALU should add its arguments</span><br><span class="line"></span><br><span class="line">##### Possible instruction status values                             #####</span><br><span class="line">wordsig SAOK	<span class="symbol">&#x27;STAT_AOK</span>&#x27;	# Normal execution</span><br><span class="line">wordsig SADR	<span class="symbol">&#x27;STAT_ADR</span>&#x27;	# Invalid memory address</span><br><span class="line">wordsig SINS	<span class="symbol">&#x27;STAT_INS</span>&#x27;	# Invalid instruction</span><br><span class="line">wordsig SHLT	<span class="symbol">&#x27;STAT_HLT</span>&#x27;	# Halt instruction encountered</span><br><span class="line"></span><br><span class="line">##### Signals that can be referenced by control logic ####################</span><br><span class="line"></span><br><span class="line">##### Fetch stage inputs		#####</span><br><span class="line">wordsig pc <span class="symbol">&#x27;pc</span>&#x27;				# Program counter</span><br><span class="line">##### Fetch stage computations		#####</span><br><span class="line">wordsig imem_icode <span class="symbol">&#x27;imem_icode</span>&#x27;		# icode field from instruction memory</span><br><span class="line">wordsig imem_ifun  <span class="symbol">&#x27;imem_ifun</span>&#x27; 		# ifun field from instruction memory</span><br><span class="line">wordsig icode	  <span class="symbol">&#x27;icode</span>&#x27;		# Instruction control code</span><br><span class="line">wordsig ifun	  <span class="symbol">&#x27;ifun</span>&#x27;		# Instruction <span class="keyword">function</span></span><br><span class="line">wordsig rA	  <span class="symbol">&#x27;ra</span>&#x27;			# rA field from instruction</span><br><span class="line">wordsig rB	  <span class="symbol">&#x27;rb</span>&#x27;			# rB field from instruction</span><br><span class="line">wordsig valC	  <span class="symbol">&#x27;valc</span>&#x27;		# <span class="keyword">Constant</span> from instruction</span><br><span class="line">wordsig valP	  <span class="symbol">&#x27;valp</span>&#x27;		# Address <span class="keyword">of</span> following instruction</span><br><span class="line">boolsig imem_error <span class="symbol">&#x27;imem_error</span>&#x27;		# <span class="literal">Error</span> <span class="keyword">signal</span> from instruction memory</span><br><span class="line">boolsig instr_valid <span class="symbol">&#x27;instr_valid</span>&#x27;	# <span class="keyword">Is</span> fetched instruction valid?</span><br><span class="line"></span><br><span class="line">##### Decode stage computations		#####</span><br><span class="line">wordsig valA	<span class="symbol">&#x27;vala</span>&#x27;			# Value from <span class="keyword">register</span> A <span class="keyword">port</span></span><br><span class="line">wordsig valB	<span class="symbol">&#x27;valb</span>&#x27;			# Value from <span class="keyword">register</span> B <span class="keyword">port</span></span><br><span class="line"></span><br><span class="line">##### Execute stage computations	#####</span><br><span class="line">wordsig valE	<span class="symbol">&#x27;vale</span>&#x27;			# Value computed by ALU</span><br><span class="line">boolsig Cnd	<span class="symbol">&#x27;cond</span>&#x27;			# Branch test</span><br><span class="line"></span><br><span class="line">##### Memory stage computations		#####</span><br><span class="line">wordsig valM	<span class="symbol">&#x27;valm</span>&#x27;			# Value read from memory</span><br><span class="line">boolsig dmem_error <span class="symbol">&#x27;dmem_error</span>&#x27;		# <span class="literal">Error</span> <span class="keyword">signal</span> from data memory</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#    Control <span class="keyword">Signal</span> Definitions.                                   #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">################ Fetch Stage     ###################################</span><br><span class="line"></span><br><span class="line"># Determine instruction code</span><br><span class="line">word icode = [</span><br><span class="line">	imem_error: INOP;</span><br><span class="line">	<span class="number">1</span>: imem_icode;		# <span class="keyword">Default</span>: get from instruction memory</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"># Determine instruction <span class="keyword">function</span></span><br><span class="line">word ifun = [</span><br><span class="line">	imem_error: FNONE;</span><br><span class="line">	<span class="number">1</span>: imem_ifun;		# <span class="keyword">Default</span>: get from instruction memory</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">bool instr_valid = icode <span class="keyword">in</span> </span><br><span class="line">	&#123; INOP, IHALT, IRRMOVQ, IIRMOVQ, IRMMOVQ, IMRMOVQ,</span><br><span class="line">	       IOPQ, IIADDQ, IJXX, ICALL, IRET, IPUSHQ, IPOPQ &#125;;</span><br><span class="line"></span><br><span class="line"># Does fetched instruction require a regid byte?</span><br><span class="line">bool need_regids =</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRRMOVQ, IOPQ, IIADDQ, IPUSHQ, IPOPQ, </span><br><span class="line">		     IIRMOVQ, IRMMOVQ, IMRMOVQ &#125;;</span><br><span class="line"></span><br><span class="line"># Does fetched instruction require a <span class="keyword">constant</span> word?</span><br><span class="line">bool need_valC =</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IJXX, ICALL, IIADDQ &#125;;</span><br><span class="line"></span><br><span class="line">################ Decode Stage    ###################################</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the A source?</span><br><span class="line">word srcA = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRRMOVQ, IRMMOVQ, IOPQ, IPUSHQ  &#125; : rA;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IPOPQ, IRET &#125; : RRSP;</span><br><span class="line">	<span class="number">1</span> : RNONE; # Don<span class="symbol">&#x27;t</span> need <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the B source?</span><br><span class="line">word srcB = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IOPQ, IRMMOVQ, IMRMOVQ, IIADDQ  &#125; : rB;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	<span class="number">1</span> : RNONE;  # Don<span class="symbol">&#x27;t</span> need <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the E destination?</span><br><span class="line">word dstE = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRRMOVQ &#125; &amp;&amp; Cnd : rB;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IIRMOVQ, IOPQ, IIADDQ &#125; : rB;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	<span class="number">1</span> : RNONE;  # Don<span class="symbol">&#x27;t</span> write any <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the M destination?</span><br><span class="line">word dstM = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ &#125; : rA;</span><br><span class="line">	<span class="number">1</span> : RNONE;  # Don<span class="symbol">&#x27;t</span> write any <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">################ Execute Stage   ###################################</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> input A <span class="keyword">to</span> ALU</span><br><span class="line">word aluA = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRRMOVQ, IOPQ &#125; : valA;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125; : valC;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; ICALL, IPUSHQ &#125; : -<span class="number">8</span>;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRET, IPOPQ &#125; : <span class="number">8</span>;</span><br><span class="line">	# Other instructions don<span class="symbol">&#x27;t</span> need ALU</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> input B <span class="keyword">to</span> ALU</span><br><span class="line">word aluB = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRMMOVQ, IMRMOVQ, IOPQ, IIADDQ, ICALL, </span><br><span class="line">		      IPUSHQ, IRET, IPOPQ &#125; : valB;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRRMOVQ, IIRMOVQ &#125; : <span class="number">0</span>;</span><br><span class="line">	# Other instructions don<span class="symbol">&#x27;t</span> need ALU</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Set the ALU <span class="keyword">function</span></span><br><span class="line">word alufun = [</span><br><span class="line">	icode == IOPQ : ifun;</span><br><span class="line">	<span class="number">1</span> : ALUADD;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Should the condition codes be updated?</span><br><span class="line">bool set_cc = icode <span class="keyword">in</span> &#123; IOPQ, IIADDQ &#125;;</span><br><span class="line"></span><br><span class="line">################ Memory Stage    ###################################</span><br><span class="line"></span><br><span class="line">## Set read control <span class="keyword">signal</span></span><br><span class="line">bool mem_read = icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ, IRET &#125;;</span><br><span class="line"></span><br><span class="line">## Set write control <span class="keyword">signal</span></span><br><span class="line">bool mem_write = icode <span class="keyword">in</span> &#123; IRMMOVQ, IPUSHQ, ICALL &#125;;</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> memory address</span><br><span class="line">word mem_addr = [</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRMMOVQ, IPUSHQ, ICALL, IMRMOVQ &#125; : valE;</span><br><span class="line">	icode <span class="keyword">in</span> &#123; IPOPQ, IRET &#125; : valA;</span><br><span class="line">	# Other instructions don<span class="symbol">&#x27;t</span> need address</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> memory input data</span><br><span class="line">word mem_data = [</span><br><span class="line">	# Value from <span class="keyword">register</span></span><br><span class="line">	icode <span class="keyword">in</span> &#123; IRMMOVQ, IPUSHQ &#125; : valA;</span><br><span class="line">	# <span class="keyword">Return</span> PC</span><br><span class="line">	icode == ICALL : valP;</span><br><span class="line">	# <span class="keyword">Default</span>: Don<span class="symbol">&#x27;t</span> write anything</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Determine instruction status</span><br><span class="line">word Stat = [</span><br><span class="line">	imem_error || dmem_error : SADR;</span><br><span class="line">	!instr_valid: SINS;</span><br><span class="line">	icode == IHALT : SHLT;</span><br><span class="line">	<span class="number">1</span> : SAOK;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">################ Program Counter Update ############################</span><br><span class="line"></span><br><span class="line">## What address should instruction be fetched at</span><br><span class="line"></span><br><span class="line">word new_pc = [</span><br><span class="line">	# Call.  <span class="keyword">Use</span> instruction <span class="keyword">constant</span></span><br><span class="line">	icode == ICALL : valC;</span><br><span class="line">	# Taken branch.  <span class="keyword">Use</span> instruction <span class="keyword">constant</span></span><br><span class="line">	icode == IJXX &amp;&amp; Cnd : valC;</span><br><span class="line">	# Completion <span class="keyword">of</span> RET instruction.  <span class="keyword">Use</span> value from stack</span><br><span class="line">	icode == IRET : valM;</span><br><span class="line">	# <span class="keyword">Default</span>: <span class="keyword">Use</span> incremented PC</span><br><span class="line">	<span class="number">1</span> : valP;</span><br><span class="line">];</span><br><span class="line">#<span class="comment">/* $end seq-all-hcl */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后按照writeup跑测试，通过。</p>
<h3 id="Part-C-1"><a href="#Part-C-1" class="headerlink" title="Part C"></a>Part C</h3><p>Part C 的具体内容就是加速内存元素的拷贝问题。修改<code>ncopy.ys</code>和<code>pipe-full.hcl</code>代码使得CPE（cycles per element）尽可能小，即单个元素拷贝时间越少越好。</p>
<p>首先添加iaddq指令，原来是通过<code>irmovq</code>和<code>addq</code>来实现的，改为iaddq指令后起到很微弱的效果，并不能明显的减少CPE，如果你的irmovq指令在循环内部那就另说了，当然也不是最快。</p>
<p><img src="csapp-lab-4/pipe.jpg"></p>
<p>具体代码如下：</p>
<figure class="highlight vhdl"><figcaption><span>文件名：archlab/archlab-handout/sim/pipe/pipe-full.hcl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line">#<span class="comment">/* $begin pipe-all-hcl */</span></span><br><span class="line">####################################################################</span><br><span class="line">#    HCL Description <span class="keyword">of</span> Control <span class="keyword">for</span> Pipelined Y86-<span class="number">64</span> Processor     #</span><br><span class="line">#    Copyright (C) Randal E. Bryant, David R. O<span class="symbol">&#x27;Hallaron</span>, <span class="number">2014</span>     #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">## Your task <span class="keyword">is</span> <span class="keyword">to</span> implement the iaddq instruction</span><br><span class="line">## The <span class="keyword">file</span> contains a declaration <span class="keyword">of</span> the icodes</span><br><span class="line">## <span class="keyword">for</span> iaddq (IIADDQ)</span><br><span class="line">## Your job <span class="keyword">is</span> <span class="keyword">to</span> add the rest <span class="keyword">of</span> the logic <span class="keyword">to</span> make it work</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#    C Include<span class="symbol">&#x27;s</span>.  Don<span class="symbol">&#x27;t</span> alter these                               #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">quote &#x27;#include &lt;stdio.h&gt;&#x27;</span><br><span class="line">quote &#x27;#include <span class="string">&quot;isa.h&quot;</span>&#x27;</span><br><span class="line">quote &#x27;#include <span class="string">&quot;pipeline.h&quot;</span>&#x27;</span><br><span class="line">quote &#x27;#include <span class="string">&quot;stages.h&quot;</span>&#x27;</span><br><span class="line">quote &#x27;#include <span class="string">&quot;sim.h&quot;</span>&#x27;</span><br><span class="line">quote <span class="symbol">&#x27;int</span> sim_main(int argc, char *argv[]);&#x27;</span><br><span class="line">quote <span class="symbol">&#x27;int</span> main(int argc, char *argv[])&#123;<span class="keyword">return</span> sim_main(argc,argv);&#125;&#x27;</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#    Declarations.  Do <span class="keyword">not</span> change/remove/delete any <span class="keyword">of</span> these       #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">##### Symbolic representation <span class="keyword">of</span> Y86-<span class="number">64</span> Instruction Codes #############</span><br><span class="line">wordsig INOP 	<span class="symbol">&#x27;I_NOP</span>&#x27;</span><br><span class="line">wordsig IHALT	<span class="symbol">&#x27;I_HALT</span>&#x27;</span><br><span class="line">wordsig IRRMOVQ	<span class="symbol">&#x27;I_RRMOVQ</span>&#x27;</span><br><span class="line">wordsig IIRMOVQ	<span class="symbol">&#x27;I_IRMOVQ</span>&#x27;</span><br><span class="line">wordsig IRMMOVQ	<span class="symbol">&#x27;I_RMMOVQ</span>&#x27;</span><br><span class="line">wordsig IMRMOVQ	<span class="symbol">&#x27;I_MRMOVQ</span>&#x27;</span><br><span class="line">wordsig IOPQ	<span class="symbol">&#x27;I_ALU</span>&#x27;</span><br><span class="line">wordsig IJXX	<span class="symbol">&#x27;I_JMP</span>&#x27;</span><br><span class="line">wordsig ICALL	<span class="symbol">&#x27;I_CALL</span>&#x27;</span><br><span class="line">wordsig IRET	<span class="symbol">&#x27;I_RET</span>&#x27;</span><br><span class="line">wordsig IPUSHQ	<span class="symbol">&#x27;I_PUSHQ</span>&#x27;</span><br><span class="line">wordsig IPOPQ	<span class="symbol">&#x27;I_POPQ</span>&#x27;</span><br><span class="line"># Instruction code <span class="keyword">for</span> iaddq instruction</span><br><span class="line">wordsig IIADDQ	<span class="symbol">&#x27;I_IADDQ</span>&#x27;</span><br><span class="line"></span><br><span class="line">##### Symbolic represenations <span class="keyword">of</span> Y86-<span class="number">64</span> <span class="keyword">function</span> codes            #####</span><br><span class="line">wordsig FNONE    <span class="symbol">&#x27;F_NONE</span>&#x27;        # <span class="keyword">Default</span> <span class="keyword">function</span> code</span><br><span class="line"></span><br><span class="line">##### Symbolic representation <span class="keyword">of</span> Y86-<span class="number">64</span> Registers referenced      #####</span><br><span class="line">wordsig RRSP     <span class="symbol">&#x27;REG_RSP</span>&#x27;    	     # Stack Pointer</span><br><span class="line">wordsig RNONE    <span class="symbol">&#x27;REG_NONE</span>&#x27;   	     # Special value indicating <span class="string">&quot;no register&quot;</span></span><br><span class="line"></span><br><span class="line">##### ALU Functions referenced explicitly ##########################</span><br><span class="line">wordsig ALUADD	<span class="symbol">&#x27;A_ADD</span>&#x27;		     # ALU should add its arguments</span><br><span class="line"></span><br><span class="line">##### Possible instruction status values                       #####</span><br><span class="line">wordsig SBUB	<span class="symbol">&#x27;STAT_BUB</span>&#x27;	# Bubble <span class="keyword">in</span> stage</span><br><span class="line">wordsig SAOK	<span class="symbol">&#x27;STAT_AOK</span>&#x27;	# Normal execution</span><br><span class="line">wordsig SADR	<span class="symbol">&#x27;STAT_ADR</span>&#x27;	# Invalid memory address</span><br><span class="line">wordsig SINS	<span class="symbol">&#x27;STAT_INS</span>&#x27;	# Invalid instruction</span><br><span class="line">wordsig SHLT	<span class="symbol">&#x27;STAT_HLT</span>&#x27;	# Halt instruction encountered</span><br><span class="line"></span><br><span class="line">##### Signals that can be referenced by control logic ##############</span><br><span class="line"></span><br><span class="line">##### Pipeline <span class="keyword">Register</span> F ##########################################</span><br><span class="line"></span><br><span class="line">wordsig F_predPC <span class="symbol">&#x27;pc_curr</span>-&gt;pc&#x27;	     # Predicted value <span class="keyword">of</span> PC</span><br><span class="line"></span><br><span class="line">##### Intermediate Values <span class="keyword">in</span> Fetch Stage ###########################</span><br><span class="line"></span><br><span class="line">wordsig imem_icode  <span class="symbol">&#x27;imem_icode</span>&#x27;      # icode field from instruction memory</span><br><span class="line">wordsig imem_ifun   <span class="symbol">&#x27;imem_ifun</span>&#x27;       # ifun  field from instruction memory</span><br><span class="line">wordsig f_icode	<span class="symbol">&#x27;if_id_next</span>-&gt;icode&#x27;  # (Possibly modified) instruction code</span><br><span class="line">wordsig f_ifun	<span class="symbol">&#x27;if_id_next</span>-&gt;ifun&#x27;   # Fetched instruction <span class="keyword">function</span></span><br><span class="line">wordsig f_valC	<span class="symbol">&#x27;if_id_next</span>-&gt;valc&#x27;   # <span class="keyword">Constant</span> data <span class="keyword">of</span> fetched instruction</span><br><span class="line">wordsig f_valP	<span class="symbol">&#x27;if_id_next</span>-&gt;valp&#x27;   # Address <span class="keyword">of</span> following instruction</span><br><span class="line">boolsig imem_error <span class="symbol">&#x27;imem_error</span>&#x27;	     # <span class="literal">Error</span> <span class="keyword">signal</span> from instruction memory</span><br><span class="line">boolsig instr_valid <span class="symbol">&#x27;instr_valid</span>&#x27;    # <span class="keyword">Is</span> fetched instruction valid?</span><br><span class="line"></span><br><span class="line">##### Pipeline <span class="keyword">Register</span> D ##########################################</span><br><span class="line">wordsig D_icode <span class="symbol">&#x27;if_id_curr</span>-&gt;icode&#x27;   # Instruction code</span><br><span class="line">wordsig D_rA <span class="symbol">&#x27;if_id_curr</span>-&gt;ra&#x27;	     # rA field from instruction</span><br><span class="line">wordsig D_rB <span class="symbol">&#x27;if_id_curr</span>-&gt;rb&#x27;	     # rB field from instruction</span><br><span class="line">wordsig D_valP <span class="symbol">&#x27;if_id_curr</span>-&gt;valp&#x27;     # Incremented PC</span><br><span class="line"></span><br><span class="line">##### Intermediate Values <span class="keyword">in</span> Decode Stage  #########################</span><br><span class="line"></span><br><span class="line">wordsig d_srcA	 <span class="symbol">&#x27;id_ex_next</span>-&gt;srca&#x27;  # srcA from decoded instruction</span><br><span class="line">wordsig d_srcB	 <span class="symbol">&#x27;id_ex_next</span>-&gt;srcb&#x27;  # srcB from decoded instruction</span><br><span class="line">wordsig d_rvalA <span class="symbol">&#x27;d_regvala</span>&#x27;	     # valA read from <span class="keyword">register</span> <span class="keyword">file</span></span><br><span class="line">wordsig d_rvalB <span class="symbol">&#x27;d_regvalb</span>&#x27;	     # valB read from <span class="keyword">register</span> <span class="keyword">file</span></span><br><span class="line"></span><br><span class="line">##### Pipeline <span class="keyword">Register</span> E ##########################################</span><br><span class="line">wordsig E_icode <span class="symbol">&#x27;id_ex_curr</span>-&gt;icode&#x27;   # Instruction code</span><br><span class="line">wordsig E_ifun  <span class="symbol">&#x27;id_ex_curr</span>-&gt;ifun&#x27;    # Instruction <span class="keyword">function</span></span><br><span class="line">wordsig E_valC  <span class="symbol">&#x27;id_ex_curr</span>-&gt;valc&#x27;    # <span class="keyword">Constant</span> data</span><br><span class="line">wordsig E_srcA  <span class="symbol">&#x27;id_ex_curr</span>-&gt;srca&#x27;    # Source A <span class="keyword">register</span> ID</span><br><span class="line">wordsig E_valA  <span class="symbol">&#x27;id_ex_curr</span>-&gt;vala&#x27;    # Source A value</span><br><span class="line">wordsig E_srcB  <span class="symbol">&#x27;id_ex_curr</span>-&gt;srcb&#x27;    # Source B <span class="keyword">register</span> ID</span><br><span class="line">wordsig E_valB  <span class="symbol">&#x27;id_ex_curr</span>-&gt;valb&#x27;    # Source B value</span><br><span class="line">wordsig E_dstE <span class="symbol">&#x27;id_ex_curr</span>-&gt;deste&#x27;    # Destination E <span class="keyword">register</span> ID</span><br><span class="line">wordsig E_dstM <span class="symbol">&#x27;id_ex_curr</span>-&gt;destm&#x27;    # Destination M <span class="keyword">register</span> ID</span><br><span class="line"></span><br><span class="line">##### Intermediate Values <span class="keyword">in</span> Execute Stage #########################</span><br><span class="line">wordsig e_valE <span class="symbol">&#x27;ex_mem_next</span>-&gt;vale&#x27;	# valE generated by ALU</span><br><span class="line">boolsig e_Cnd <span class="symbol">&#x27;ex_mem_next</span>-&gt;takebranch&#x27; # Does condition hold?</span><br><span class="line">wordsig e_dstE <span class="symbol">&#x27;ex_mem_next</span>-&gt;deste&#x27;      # dstE (possibly modified <span class="keyword">to</span> be RNONE)</span><br><span class="line"></span><br><span class="line">##### Pipeline <span class="keyword">Register</span> M                  #########################</span><br><span class="line">wordsig M_stat <span class="symbol">&#x27;ex_mem_curr</span>-&gt;status&#x27;     # Instruction status</span><br><span class="line">wordsig M_icode <span class="symbol">&#x27;ex_mem_curr</span>-&gt;icode&#x27;	# Instruction code</span><br><span class="line">wordsig M_ifun  <span class="symbol">&#x27;ex_mem_curr</span>-&gt;ifun&#x27;	# Instruction <span class="keyword">function</span></span><br><span class="line">wordsig M_valA  <span class="symbol">&#x27;ex_mem_curr</span>-&gt;vala&#x27;      # Source A value</span><br><span class="line">wordsig M_dstE <span class="symbol">&#x27;ex_mem_curr</span>-&gt;deste&#x27;	# Destination E <span class="keyword">register</span> ID</span><br><span class="line">wordsig M_valE  <span class="symbol">&#x27;ex_mem_curr</span>-&gt;vale&#x27;      # ALU E value</span><br><span class="line">wordsig M_dstM <span class="symbol">&#x27;ex_mem_curr</span>-&gt;destm&#x27;	# Destination M <span class="keyword">register</span> ID</span><br><span class="line">boolsig M_Cnd <span class="symbol">&#x27;ex_mem_curr</span>-&gt;takebranch&#x27;	# Condition flag</span><br><span class="line">boolsig dmem_error <span class="symbol">&#x27;dmem_error</span>&#x27;	        # <span class="literal">Error</span> <span class="keyword">signal</span> from instruction memory</span><br><span class="line"></span><br><span class="line">##### Intermediate Values <span class="keyword">in</span> Memory Stage ##########################</span><br><span class="line">wordsig m_valM <span class="symbol">&#x27;mem_wb_next</span>-&gt;valm&#x27;	# valM generated by memory</span><br><span class="line">wordsig m_stat <span class="symbol">&#x27;mem_wb_next</span>-&gt;status&#x27;	# stat (possibly modified <span class="keyword">to</span> be SADR)</span><br><span class="line"></span><br><span class="line">##### Pipeline <span class="keyword">Register</span> W ##########################################</span><br><span class="line">wordsig W_stat <span class="symbol">&#x27;mem_wb_curr</span>-&gt;status&#x27;     # Instruction status</span><br><span class="line">wordsig W_icode <span class="symbol">&#x27;mem_wb_curr</span>-&gt;icode&#x27;	# Instruction code</span><br><span class="line">wordsig W_dstE <span class="symbol">&#x27;mem_wb_curr</span>-&gt;deste&#x27;	# Destination E <span class="keyword">register</span> ID</span><br><span class="line">wordsig W_valE  <span class="symbol">&#x27;mem_wb_curr</span>-&gt;vale&#x27;      # ALU E value</span><br><span class="line">wordsig W_dstM <span class="symbol">&#x27;mem_wb_curr</span>-&gt;destm&#x27;	# Destination M <span class="keyword">register</span> ID</span><br><span class="line">wordsig W_valM  <span class="symbol">&#x27;mem_wb_curr</span>-&gt;valm&#x27;	# Memory M value</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#    Control <span class="keyword">Signal</span> Definitions.                                   #</span><br><span class="line">####################################################################</span><br><span class="line"></span><br><span class="line">################ Fetch Stage     ###################################</span><br><span class="line"></span><br><span class="line">## What address should instruction be fetched at</span><br><span class="line">word f_pc = [</span><br><span class="line">	# Mispredicted branch.  Fetch at incremented PC</span><br><span class="line">	M_icode == IJXX &amp;&amp; !M_Cnd : M_valA;</span><br><span class="line">	# Completion <span class="keyword">of</span> RET instruction</span><br><span class="line">	W_icode == IRET : W_valM;</span><br><span class="line">	# <span class="keyword">Default</span>: <span class="keyword">Use</span> predicted value <span class="keyword">of</span> PC</span><br><span class="line">	<span class="number">1</span> : F_predPC;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Determine icode <span class="keyword">of</span> fetched instruction</span><br><span class="line">word f_icode = [</span><br><span class="line">	imem_error : INOP;</span><br><span class="line">	<span class="number">1</span>: imem_icode;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"># Determine ifun</span><br><span class="line">word f_ifun = [</span><br><span class="line">	imem_error : FNONE;</span><br><span class="line">	<span class="number">1</span>: imem_ifun;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"># <span class="keyword">Is</span> instruction valid?</span><br><span class="line">bool instr_valid = f_icode <span class="keyword">in</span> </span><br><span class="line">	&#123; INOP, IHALT, IRRMOVQ, IIRMOVQ, IRMMOVQ, IMRMOVQ,</span><br><span class="line">	  IOPQ, IIADDQ, IJXX, ICALL, IRET, IPUSHQ, IPOPQ &#125;;</span><br><span class="line"></span><br><span class="line"># Determine status code <span class="keyword">for</span> fetched instruction</span><br><span class="line">word f_stat = [</span><br><span class="line">	imem_error: SADR;</span><br><span class="line">	!instr_valid : SINS;</span><br><span class="line">	f_icode == IHALT : SHLT;</span><br><span class="line">	<span class="number">1</span> : SAOK;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"># Does fetched instruction require a regid byte?</span><br><span class="line">bool need_regids =</span><br><span class="line">	f_icode <span class="keyword">in</span> &#123; IRRMOVQ, IOPQ, IIADDQ, IPUSHQ, IPOPQ, </span><br><span class="line">		     IIRMOVQ, IRMMOVQ, IMRMOVQ &#125;;</span><br><span class="line"></span><br><span class="line"># Does fetched instruction require a <span class="keyword">constant</span> word?</span><br><span class="line">bool need_valC =</span><br><span class="line">	f_icode <span class="keyword">in</span> &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IJXX, ICALL, IIADDQ &#125;;</span><br><span class="line"></span><br><span class="line"># Predict <span class="keyword">next</span> value <span class="keyword">of</span> PC</span><br><span class="line">word f_predPC = [</span><br><span class="line">	f_icode <span class="keyword">in</span> &#123; IJXX, ICALL &#125; : f_valC;</span><br><span class="line">	<span class="number">1</span> : f_valP;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">################ Decode Stage ######################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the A source?</span><br><span class="line">word d_srcA = [</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IRRMOVQ, IRMMOVQ, IOPQ, IPUSHQ  &#125; : D_rA;</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IPOPQ, IRET &#125; : RRSP;</span><br><span class="line">	<span class="number">1</span> : RNONE; # Don<span class="symbol">&#x27;t</span> need <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the B source?</span><br><span class="line">word d_srcB = [</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IOPQ, IIADDQ, IRMMOVQ, IMRMOVQ  &#125; : D_rB;</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	<span class="number">1</span> : RNONE;  # Don<span class="symbol">&#x27;t</span> need <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the E destination?</span><br><span class="line">word d_dstE = [</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IRRMOVQ, IIRMOVQ, IOPQ, IIADDQ &#125; : D_rB;</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;</span><br><span class="line">	<span class="number">1</span> : RNONE;  # Don<span class="symbol">&#x27;t</span> write any <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What <span class="keyword">register</span> should be used as the M destination?</span><br><span class="line">word d_dstM = [</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ &#125; : D_rA;</span><br><span class="line">	<span class="number">1</span> : RNONE;  # Don<span class="symbol">&#x27;t</span> write any <span class="keyword">register</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## What should be the A value?</span><br><span class="line">## Forward into decode stage <span class="keyword">for</span> valA</span><br><span class="line">word d_valA = [</span><br><span class="line">	D_icode <span class="keyword">in</span> &#123; ICALL, IJXX &#125; : D_valP; # <span class="keyword">Use</span> incremented PC</span><br><span class="line">	d_srcA == e_dstE : e_valE;    # Forward valE from execute</span><br><span class="line">	d_srcA == M_dstM : m_valM;    # Forward valM from memory</span><br><span class="line">	d_srcA == M_dstE : M_valE;    # Forward valE from memory</span><br><span class="line">	d_srcA == W_dstM : W_valM;    # Forward valM from write back</span><br><span class="line">	d_srcA == W_dstE : W_valE;    # Forward valE from write back</span><br><span class="line">	<span class="number">1</span> : d_rvalA;  # <span class="keyword">Use</span> value read from <span class="keyword">register</span> <span class="keyword">file</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">word d_valB = [</span><br><span class="line">	d_srcB == e_dstE : e_valE;    # Forward valE from execute</span><br><span class="line">	d_srcB == M_dstM : m_valM;    # Forward valM from memory</span><br><span class="line">	d_srcB == M_dstE : M_valE;    # Forward valE from memory</span><br><span class="line">	d_srcB == W_dstM : W_valM;    # Forward valM from write back</span><br><span class="line">	d_srcB == W_dstE : W_valE;    # Forward valE from write back</span><br><span class="line">	<span class="number">1</span> : d_rvalB;  # <span class="keyword">Use</span> value read from <span class="keyword">register</span> <span class="keyword">file</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">################ Execute Stage #####################################</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> input A <span class="keyword">to</span> ALU</span><br><span class="line">word aluA = [</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IRRMOVQ, IOPQ &#125; : E_valA;</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IIRMOVQ, IRMMOVQ, IMRMOVQ, IIADDQ &#125; : E_valC;</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; ICALL, IPUSHQ &#125; : -<span class="number">8</span>;</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IRET, IPOPQ &#125; : <span class="number">8</span>;</span><br><span class="line">	# Other instructions don<span class="symbol">&#x27;t</span> need ALU</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> input B <span class="keyword">to</span> ALU</span><br><span class="line">word aluB = [</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IRMMOVQ, IMRMOVQ, IOPQ, IIADDQ, ICALL, </span><br><span class="line">		     IPUSHQ, IRET, IPOPQ &#125; : E_valB;</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IRRMOVQ, IIRMOVQ &#125; : <span class="number">0</span>;</span><br><span class="line">	# Other instructions don<span class="symbol">&#x27;t</span> need ALU</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Set the ALU <span class="keyword">function</span></span><br><span class="line">word alufun = [</span><br><span class="line">	E_icode == IOPQ : E_ifun;</span><br><span class="line">	<span class="number">1</span> : ALUADD;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Should the condition codes be updated?</span><br><span class="line">bool set_cc = (E_icode == IOPQ||E_icode == IIADDQ) &amp;&amp;</span><br><span class="line">	# State changes only during normal operation</span><br><span class="line">	!m_stat <span class="keyword">in</span> &#123; SADR, SINS, SHLT &#125; &amp;&amp; !W_stat <span class="keyword">in</span> &#123; SADR, SINS, SHLT &#125;;</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Generate</span> valA <span class="keyword">in</span> execute stage</span><br><span class="line">word e_valA = E_valA;    # Pass valA through stage</span><br><span class="line"></span><br><span class="line">## Set dstE <span class="keyword">to</span> RNONE <span class="keyword">in</span> event <span class="keyword">of</span> <span class="keyword">not</span>-taken conditional move</span><br><span class="line">word e_dstE = [</span><br><span class="line">	E_icode == IRRMOVQ &amp;&amp; !e_Cnd : RNONE;</span><br><span class="line">	<span class="number">1</span> : E_dstE;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">################ Memory Stage ######################################</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Select</span> memory address</span><br><span class="line">word mem_addr = [</span><br><span class="line">	M_icode <span class="keyword">in</span> &#123; IRMMOVQ, IPUSHQ, ICALL, IMRMOVQ &#125; : M_valE;</span><br><span class="line">	M_icode <span class="keyword">in</span> &#123; IPOPQ, IRET &#125; : M_valA;</span><br><span class="line">	# Other instructions don<span class="symbol">&#x27;t</span> need address</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">## Set read control <span class="keyword">signal</span></span><br><span class="line">bool mem_read = M_icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ, IRET &#125;;</span><br><span class="line"></span><br><span class="line">## Set write control <span class="keyword">signal</span></span><br><span class="line">bool mem_write = M_icode <span class="keyword">in</span> &#123; IRMMOVQ, IPUSHQ, ICALL &#125;;</span><br><span class="line"></span><br><span class="line">#<span class="comment">/* $begin pipe-m_stat-hcl */</span></span><br><span class="line">## Update the status</span><br><span class="line">word m_stat = [</span><br><span class="line">	dmem_error : SADR;</span><br><span class="line">	<span class="number">1</span> : M_stat;</span><br><span class="line">];</span><br><span class="line">#<span class="comment">/* $end pipe-m_stat-hcl */</span></span><br><span class="line"></span><br><span class="line">## Set E <span class="keyword">port</span> <span class="keyword">register</span> ID</span><br><span class="line">word w_dstE = W_dstE;</span><br><span class="line"></span><br><span class="line">## Set E <span class="keyword">port</span> value</span><br><span class="line">word w_valE = W_valE;</span><br><span class="line"></span><br><span class="line">## Set M <span class="keyword">port</span> <span class="keyword">register</span> ID</span><br><span class="line">word w_dstM = W_dstM;</span><br><span class="line"></span><br><span class="line">## Set M <span class="keyword">port</span> value</span><br><span class="line">word w_valM = W_valM;</span><br><span class="line"></span><br><span class="line">## Update processor status</span><br><span class="line">word Stat = [</span><br><span class="line">	W_stat == SBUB : SAOK;</span><br><span class="line">	<span class="number">1</span> : W_stat;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">################ Pipeline <span class="keyword">Register</span> Control #########################</span><br><span class="line"></span><br><span class="line"># Should I stall <span class="keyword">or</span> inject a bubble into Pipeline <span class="keyword">Register</span> F?</span><br><span class="line"># At most one <span class="keyword">of</span> these can be <span class="literal">true</span>.</span><br><span class="line">bool F_bubble = <span class="number">0</span>;</span><br><span class="line">bool F_stall =</span><br><span class="line">	# Conditions <span class="keyword">for</span> a load/<span class="keyword">use</span> hazard</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp;</span><br><span class="line">	 E_dstM <span class="keyword">in</span> &#123; d_srcA, d_srcB &#125; ||</span><br><span class="line">	# Stalling at fetch <span class="keyword">while</span> ret passes through pipeline</span><br><span class="line">	IRET <span class="keyword">in</span> &#123; D_icode, E_icode, M_icode &#125;;</span><br><span class="line"></span><br><span class="line"># Should I stall <span class="keyword">or</span> inject a bubble into Pipeline <span class="keyword">Register</span> D?</span><br><span class="line"># At most one <span class="keyword">of</span> these can be <span class="literal">true</span>.</span><br><span class="line">bool D_stall = </span><br><span class="line">	# Conditions <span class="keyword">for</span> a load/<span class="keyword">use</span> hazard</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp;</span><br><span class="line">	 E_dstM <span class="keyword">in</span> &#123; d_srcA, d_srcB &#125;;</span><br><span class="line"></span><br><span class="line">bool D_bubble =</span><br><span class="line">	# Mispredicted branch</span><br><span class="line">	(E_icode == IJXX &amp;&amp; !e_Cnd) ||</span><br><span class="line">	# Stalling at fetch <span class="keyword">while</span> ret passes through pipeline</span><br><span class="line">	# but <span class="keyword">not</span> condition <span class="keyword">for</span> a load/<span class="keyword">use</span> hazard</span><br><span class="line">	!(E_icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp; E_dstM <span class="keyword">in</span> &#123; d_srcA, d_srcB &#125;) &amp;&amp;</span><br><span class="line">	  IRET <span class="keyword">in</span> &#123; D_icode, E_icode, M_icode &#125;;</span><br><span class="line"></span><br><span class="line"># Should I stall <span class="keyword">or</span> inject a bubble into Pipeline <span class="keyword">Register</span> E?</span><br><span class="line"># At most one <span class="keyword">of</span> these can be <span class="literal">true</span>.</span><br><span class="line">bool E_stall = <span class="number">0</span>;</span><br><span class="line">bool E_bubble =</span><br><span class="line">	# Mispredicted branch</span><br><span class="line">	(E_icode == IJXX &amp;&amp; !e_Cnd) ||</span><br><span class="line">	# Conditions <span class="keyword">for</span> a load/<span class="keyword">use</span> hazard</span><br><span class="line">	E_icode <span class="keyword">in</span> &#123; IMRMOVQ, IPOPQ &#125; &amp;&amp;</span><br><span class="line">	 E_dstM <span class="keyword">in</span> &#123; d_srcA, d_srcB&#125;;</span><br><span class="line"></span><br><span class="line"># Should I stall <span class="keyword">or</span> inject a bubble into Pipeline <span class="keyword">Register</span> M?</span><br><span class="line"># At most one <span class="keyword">of</span> these can be <span class="literal">true</span>.</span><br><span class="line">bool M_stall = <span class="number">0</span>;</span><br><span class="line"># Start injecting bubbles as soon as exception passes through memory stage</span><br><span class="line">bool M_bubble = m_stat <span class="keyword">in</span> &#123; SADR, SINS, SHLT &#125; || W_stat <span class="keyword">in</span> &#123; SADR, SINS, SHLT &#125;;</span><br><span class="line"></span><br><span class="line"># Should I stall <span class="keyword">or</span> inject a bubble into Pipeline <span class="keyword">Register</span> W?</span><br><span class="line">bool W_stall = W_stat <span class="keyword">in</span> &#123; SADR, SINS, SHLT &#125;;</span><br><span class="line">bool W_bubble = <span class="number">0</span>;</span><br><span class="line">#<span class="comment">/* $end pipe-all-hcl */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后修改ncopy.ys文件</p>
<h4 id="Version-1-0"><a href="#Version-1-0" class="headerlink" title="Version 1.0"></a>Version 1.0</h4><figure class="highlight x86asm"><figcaption><span>文件名：archlab/archlab-handout/sim/pipe/ncopy.ys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#/* $begin ncopy-ys */</span><br><span class="line">##################################################################</span><br><span class="line"># ncopy<span class="number">.</span>ys - Copy a src block of len words to dst.</span><br><span class="line"># Return the number of positive words (&gt;<span class="number">0</span>) contained <span class="keyword">in</span> src.</span><br><span class="line">#</span><br><span class="line"># Include your name <span class="keyword">and</span> ID here.</span><br><span class="line">#</span><br><span class="line"># Describe how <span class="keyword">and</span> why you modified the baseline code.</span><br><span class="line">#</span><br><span class="line">##################################################################</span><br><span class="line"># <span class="built_in">Do</span> <span class="keyword">not</span> modify this portion</span><br><span class="line"># Function prologue.</span><br><span class="line"># %rdi = src, %rsi = dst, %rdx = len</span><br><span class="line"><span class="symbol">ncopy:</span></span><br><span class="line"></span><br><span class="line">##################################################################</span><br><span class="line"># You can modify this portion</span><br><span class="line">	# <span class="keyword">Loop</span> header</span><br><span class="line">	xorq %rax,%rax		# count = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">	andq %rdx,%rdx		# len &lt;= <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jle</span> Done		# if so, goto Done:</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">Loop:</span>	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	andq %r10, %r10		# val &lt;= <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jle</span> Npos		# if so, goto Npos:</span><br><span class="line">	iaddq <span class="number">$1</span>, %rax		# count++</span><br><span class="line"><span class="symbol">Npos:</span>	</span><br><span class="line">	iaddq $-<span class="number">1</span>, %rdx		# len--</span><br><span class="line">	iaddq <span class="number">$8</span>, %rdi		# src++</span><br><span class="line">	iaddq <span class="number">$8</span>, %rsi		# dst++</span><br><span class="line">	andq %rdx,%rdx		# len &gt; <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jg</span> <span class="keyword">Loop</span>			# if so, goto <span class="keyword">Loop</span>:</span><br><span class="line">##################################################################</span><br><span class="line"># <span class="built_in">Do</span> <span class="keyword">not</span> modify the following <span class="meta">section</span> of code</span><br><span class="line"># Function epilogue.</span><br><span class="line"><span class="symbol">Done:</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">##################################################################</span><br><span class="line"># Keep the following label <span class="meta">at</span> the end of your function</span><br><span class="line"><span class="symbol">End:</span></span><br><span class="line">#/* $end ncopy-ys */</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然而还是0分。</p>
<p><img src="csapp-lab-4/result.png"></p>
<p>主要考虑还是要减少bubble，还有程序优化问题。</p>
<p>看完第五章再来二刷吧。</p>
<h4 id="Version-2-0"><a href="#Version-2-0" class="headerlink" title="Version 2.0"></a>Version 2.0</h4><p>结果：<br><img src="csapp-lab-4/result2.png"></p>
<p>所作修改：</p>
<ul>
<li>4x4循环展开，因为C=4，L=1</li>
<li>消除了一些load/use指令组合</li>
</ul>
<figure class="highlight x86asm"><figcaption><span>文件名：archlab/archlab-handout/sim/pipe/ncopy.ys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#/* $begin ncopy-ys */</span><br><span class="line">##################################################################</span><br><span class="line"># ncopy<span class="number">.</span>ys - Copy a src block of len words to dst.</span><br><span class="line"># Return the number of positive words (&gt;<span class="number">0</span>) contained <span class="keyword">in</span> src.</span><br><span class="line">#</span><br><span class="line"># Include your name <span class="keyword">and</span> ID here.</span><br><span class="line">#</span><br><span class="line"># Describe how <span class="keyword">and</span> why you modified the baseline code.</span><br><span class="line">#</span><br><span class="line">##################################################################</span><br><span class="line"># <span class="built_in">Do</span> <span class="keyword">not</span> modify this portion</span><br><span class="line"># Function prologue.</span><br><span class="line"># %rdi = src, %rsi = dst, %rdx = len</span><br><span class="line"><span class="symbol">ncopy:</span></span><br><span class="line"></span><br><span class="line">##################################################################</span><br><span class="line"># You can modify this portion</span><br><span class="line">	# <span class="keyword">Loop</span> header</span><br><span class="line">	xorq %rax,%rax		# count = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">	andq %rdx,%rdx		# len &lt;= <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jle</span> Done		# if so, goto Done:</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">testType:</span></span><br><span class="line">	irmovq <span class="number">$3</span>,%r8</span><br><span class="line">	andq %rdx, %r8</span><br><span class="line">	<span class="keyword">je</span> <span class="keyword">Loop</span></span><br><span class="line">	rrmovq %r8,%r11</span><br><span class="line">	irmovq <span class="number">$1</span>, %rcx</span><br><span class="line"><span class="symbol">originLoop:</span></span><br><span class="line">	mrmovq (%rdi), %r10</span><br><span class="line">	iaddq <span class="number">$8</span>, %rdi		# src++</span><br><span class="line">	andq %r10, %r10</span><br><span class="line">	rmmovq %r10, (%rsi)</span><br><span class="line">	<span class="keyword">jle</span> <span class="keyword">neg</span></span><br><span class="line">	iaddq <span class="number">$1</span>, %rax</span><br><span class="line"><span class="symbol">neg:</span></span><br><span class="line">	iaddq <span class="number">$8</span>, %rsi		# dst++</span><br><span class="line">	subq %rcx, %r8</span><br><span class="line">	<span class="keyword">jg</span> originLoop</span><br><span class="line">	subq %r11,%rdx		# len &gt; <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jle</span> Done</span><br><span class="line"><span class="symbol">Loop:</span>	</span><br><span class="line">	mrmovq (%rdi), %r10	# read val from src...</span><br><span class="line">	mrmovq <span class="number">8</span>(%rdi), %r11</span><br><span class="line">	mrmovq <span class="number">16</span>(%rdi), %r8</span><br><span class="line">	mrmovq <span class="number">24</span>(%rdi), %r9</span><br><span class="line">	rmmovq %r10, (%rsi)	# ...and store it to dst</span><br><span class="line">	rmmovq %r11, <span class="number">8</span>(%rsi)</span><br><span class="line">	rmmovq %r8, <span class="number">16</span>(%rsi)</span><br><span class="line">	rmmovq %r9, <span class="number">24</span>(%rsi)</span><br><span class="line">	andq %r10, %r10		# val &lt;= <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jle</span> second		# if so,go next item:</span><br><span class="line">	iaddq <span class="number">$1</span>, %rax		# count++</span><br><span class="line"><span class="symbol">second:</span></span><br><span class="line">	andq %r11, %r11</span><br><span class="line">	<span class="keyword">jle</span> third</span><br><span class="line">	iaddq <span class="number">$1</span>, %rax</span><br><span class="line"><span class="symbol">third:</span></span><br><span class="line">	andq %r8, %r8</span><br><span class="line">	<span class="keyword">jle</span> forth</span><br><span class="line">	iaddq <span class="number">$1</span>, %rax</span><br><span class="line"><span class="symbol">forth:</span></span><br><span class="line">	andq %r9, %r9</span><br><span class="line">	<span class="keyword">jle</span> Npos</span><br><span class="line">	iaddq <span class="number">$1</span>, %rax</span><br><span class="line"><span class="symbol">Npos:</span>	</span><br><span class="line">	iaddq $-<span class="number">4</span>, %rdx		# len--</span><br><span class="line">	iaddq <span class="number">$32</span>, %rdi		# src++</span><br><span class="line">	iaddq <span class="number">$32</span>, %rsi		# dst++</span><br><span class="line">	andq %rdx,%rdx		# len &gt; <span class="number">0</span>?</span><br><span class="line">	<span class="keyword">jg</span> <span class="keyword">Loop</span>			# if so, goto <span class="keyword">Loop</span>:</span><br><span class="line">##################################################################</span><br><span class="line"># <span class="built_in">Do</span> <span class="keyword">not</span> modify the following <span class="meta">section</span> of code</span><br><span class="line"># Function epilogue.</span><br><span class="line"><span class="symbol">Done:</span></span><br><span class="line">	<span class="keyword">ret</span></span><br><span class="line">##################################################################</span><br><span class="line"># Keep the following label <span class="meta">at</span> the end of your function</span><br><span class="line"><span class="symbol">End:</span></span><br><span class="line">#/* $end ncopy-ys */</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>粗略的总结了一下。有问题请在评论区或者daovoice指正。</p>
<h3 id="所感"><a href="#所感" class="headerlink" title="所感"></a>所感</h3><ol>
<li>最近做问题不够专注，时间观念不够强，可能是太过松散了</li>
<li>。。。</li>
</ol>
<h3 id="所得"><a href="#所得" class="headerlink" title="所得"></a>所得</h3><ol>
<li>从阅读《编码》这本书中浅浅的了解了处理器体系结构，到csapp3e进一步了解</li>
<li>熟悉了ISA设计的基本方法，指令分类、分阶段、流水线、冒险问题、异常处理、性能评价等</li>
</ol>
<h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><ol>
<li>阅读第5章，二刷part C</li>
<li>使用番茄todo做好时间规划，并执行训练</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CSAPP/" rel="tag"># CSAPP</a>
              <a href="/tags/Operating-System/" rel="tag"># Operating System</a>
              <a href="/tags/CSAPP-Lab/" rel="tag"># CSAPP Lab</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/threshold-segmentation/" rel="prev" title="阈值分割">
                  <i class="fa fa-chevron-left"></i> 阈值分割
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/fallout4/" rel="next" title="找儿子——《辐射4》：游戏评测日志">
                  找儿子——《辐射4》：游戏评测日志 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李明岳</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script class="next-config" data-name="nprogress" type="application/json">{"enable":true,"spinner":true}</script>
  <script src="/js/third-party/nprogress.js"></script>

  





</body>
</html>
